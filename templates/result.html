<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Portfolio Result</title>
    <link rel="stylesheet" type="text/css" href="{% static 'styles.css' %}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="container">
        <form method="POST" id="portfolio-form">
            {% csrf_token %}
            <label for="selected_assets">Choose portfolio:</label>
            <input type="text" id="portfolio_list" name="portfolio_list" list="portfolio-list" multiple>
            <datalist id="portfolio-list"></datalist>
            <button type="button" id="view-portfolio">View portf</button>
        </form>
    </div>

    <div class="container result-page">
        <div class="result-details">
            <h3>Assets weights:</h3>
            <ul></ul>
            <h3>Indicators:</h3>
            <p></p>
        </div>
        
        <div class="charts">
            <h2>A summary chart of asset values ​​over time</h2>
            <img src="{% static 'plot1.png' %}" alt="Wykres zbiorczy wartości aktywów w czasie">
        
            <h2>Graph of portfolio performance over time</h2>
            <img src="{% static 'plot2.png' %}" alt="Wykres wyników portfela w zależności od czasu">
        
            <h2>Pie chart with weights</h2>
            <img src="{% static 'plot3.png' %}" alt="Wykres kołowy z wagami">
        </div>
    </div>

    <script>
        $(document).ready(function() {
            var currentURL = window.location.href;
            var urlParts = currentURL.split('/');
            var walletName = urlParts[urlParts.length - 1];

            $.ajax({
                url: '/api/wallets/',
                method: 'GET',
                success: function(data) {
                    // Wyczyść datalist
                    $('#portfolio-list').empty();
    
                    // Wypełnij datalist nazwami portfolio z pobranych danych
                    $.each(data, function(index, portfolio) {
                        $('#portfolio-list').append(`<option value="${portfolio.name}">`);
                    });
                },
                error: function() {
                    alert('Błąd podczas pobierania listy portfolio.');
                }
            });

            $.ajax({
                url: `/api/wallets/${walletName}`,
                method: 'GET',
                success: function(data) {
                    var portfolioAssets = data.asset_weights;  // Pobierz dane dotyczące aktywów wraz z wagami            
                    var parameters = 'expected risk= ' + data.risk + '%<br>' + 'expected return= ' + data.retur + '%<br>';
                    var maxDrawdown = data.max_drawdown;
            
                    // Wyświetl dane na stronie
                    $('.result-details ul').empty();
                    $.each(portfolioAssets, function(index, portfolioAsset) {
                        var name = portfolioAsset.asset.name;
                        var weight = portfolioAsset.weight;
                        $('.result-details ul').append(`<li>${name} (${weight}%)`);
                    });
                    $('.result-details p').html(parameters);
                    $('.result-details p').append(`max drawdown = ${maxDrawdown}%`);
                },
                error: function() {
                    alert('Błąd podczas pobierania danych portfela.');
                }
            });
        });
    </script>   

</body>
</html>
